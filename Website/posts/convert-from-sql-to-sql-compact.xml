<?xml version="1.0" encoding="utf-8"?>
<post>
  <title>Convert from SQL to SQL Compact</title>
  <slug>convert-from-sql-to-sql-compact</slug>
  <author>Jan</author>
  <pubDate>2012-11-10 16:08:55</pubDate>
  <lastModified>2014-04-25 12:06:07</lastModified>
  <content>&lt;p&gt;When setting up an Orchard website you’re given a choice to use a ‘normal’ SQL database, or SQL Compact. When developing new modules I often choose for the SQL Compact option. I choose this option, because it’s very easy to backup and restore the database file. If you mess something up, you’re fairly safe. &lt;br&gt;You can of course backup and restore normal SQL databases, but this takes a bit more effort compared to copy-pasting a database file. &lt;/p&gt; &lt;p&gt;I hardly ever use a SQL Compact database in other environments as development. This means whenever I need a dump from the Testing environment to Development I’ll get a normal database backup file, or &lt;a href="http://jan-v.nl/import-sql-azure-database-on-local-machine"&gt;a bacpac export file&lt;/a&gt;. These files can only be restored to normal SQL databases, so that’s a small problem. &lt;br&gt;Apparently no one at the SQL-team has considered that someone might actually want to ‘downgrade’ their database to SQL Compact. &lt;/p&gt; &lt;p&gt;When searching the web you’ll find a lot of pages people asking the question “&lt;em&gt;&lt;a href="https://www.google.com/?q=How%20can%20a%20SQL%20database%20be%20migrated%20to%20SQL%20Compact"&gt;How can a SQL database be migrated to SQL Compact&lt;/a&gt;&lt;/em&gt;”. As it happens, migrating to SQL Compact is rather easy, once you’ve found the appropriate posts on Stack Overflow. &lt;a href="https://twitter.com/ErikEJ"&gt;@ErikEJ&lt;/a&gt; has written 2 applications which make it really easy to do such a migration. &lt;/p&gt; &lt;p&gt;First there’s the &lt;a href="http://exportsqlce.codeplex.com/"&gt;ExportSqlCe&lt;/a&gt; application. This application is able to generate scripts of the database you wish to migrate which can be executed on a SQL Compact database.&lt;/p&gt; &lt;p&gt;The second application is &lt;a href="http://sqlcecmd.codeplex.com/"&gt;SqlCeCmd&lt;/a&gt; application. This application is able to do a variety of actions on a SQL Compact database, like the creation of such a file and running SQL scripts.&lt;/p&gt; &lt;p&gt;Erik &lt;a href="http://erikej.blogspot.nl/2010/02/how-to-use-exportsqlce-to-migrate-from.html"&gt;describes all steps necessary to do a migration from a SQL to a SQL Compact database on his blog&lt;/a&gt;. All you need to do is execute the following commands (with your own settings of course)&lt;/p&gt;&lt;pre class="brush: shell; toolbar: false"&gt;Export2sqlce "Data Source=(local);Initial Catalog=AdventureworksLT;Integrated Security=True" AW.sqlce

sqlcecmd40 -d "Data Source=C:\aw.sdf" -e create

sqlcecmd40 -d "Data Source=C:\aw.sdf" -i aw.sqlce &amp;gt; log.txt&lt;/pre&gt;
&lt;p&gt;Let’s go through this step by step.&lt;/p&gt;
&lt;p&gt;The first command creates an export script of the database you wish to migrate. The first parameter of Export2SqlCe is the connectionstring to the database you wish to migrate, the second parameter is the output file where the script will be saved. This script will be imported later on.&lt;/p&gt;
&lt;p&gt;The second command will create a new SQL Compact database file, no need to explain the parameters.&lt;/p&gt;
&lt;p&gt;The third command will use the newly created database file and run the SQL script in it. &lt;/p&gt;
&lt;p&gt;After having successfully executed these commands, you’ll have a new SQL Compact database containing all information of the selected SQL database. All of this will only work if the database is capable of being migrated of course. SQL Compact is not able to do everything a real SQL database can.&lt;/p&gt;
&lt;p&gt;Looing at the above steps, there’s a lot of typing and repetition involved. Because I’m a developer and have to &lt;a href="http://www.hanselman.com/blog/DoTheyDeserveTheGiftOfYourKeystrokes.aspx"&gt;save my keystrokes&lt;/a&gt;, I’ve created a PowerShell script which will minimize the amount of typing you need to do when migrating. As you can see, executing this script requires you to have both executables (Export2SqlCe &amp;amp; SqlCeCmd40) to be in the same directory as the script, otherwise it won’t work. Also, I’m not a PowerShell guru, so if you have any improvements for the script, let me know.&lt;/p&gt;&lt;pre class="brush: powershell; toolbar: false"&gt;param(
	[string]$connectionString = "",
	[string]$databaseName = ""
)

$sqlCEScriptFile = ".\CreateSQLCEDatabaseScript.sqlce"

function CreateSQLScript
{
	try
	{
		IF (Test-Path $sqlCEScriptFile){
			Write-Host "Removing old script file"
			Remove-Item $sqlCEScriptFile
		}
		Write-Host "Starting to create an export of the specified database in the connectionstring parameter."
		&amp;amp; .\export2sqlce.exe "$connectionString" $sqlCEScriptFile
		Write-Host "Finished exporting the script"
	}
	catch
	{
		Write-Host "Exporting the script failed!"
		throw
	}
}

function CreateDatabaseFile
{
	try
	{
		IF (Test-Path ".\$databaseName"){
			Write-Host "Removing old database file"
			Remove-Item ".\$databaseName"
		}
		Write-Host "Creating a new Compact Database file"
		&amp;amp; .\sqlcecmd40.exe -d "Data Source=.\$databaseName" -e create
		Write-Host "Finished creating the Compact Database file"
	}
	catch
	{
		Write-Host "Failed creating the database file!"
		throw
	}
}

function FillUpTheDatabase
{
	try
	{
		Write-Host "Importing the script into the database"
		&amp;amp; .\sqlcecmd40.exe -d "Data Source=.\$databaseName" -i $sqlCEScriptFile &amp;gt; .\log.txt
		Write-Host "Finished importing the script"
	}
	catch
	{
		Write-Host "Failed importing the script to the database!"
		throw
	}
}


try
{
	CreateSQLScript
	CreateDatabaseFile
	FillUpTheDatabase
}
catch
{
	Write-Host "Failed creating a good export!"
}&lt;/pre&gt;
&lt;p&gt;Just specify the connectionstring and name of the SQL Compact database file when running the script and you’re good to go.&lt;/p&gt;
&lt;p&gt;Hope this will help you migrating your SQL databases to SQL Compact.&lt;/p&gt;</content>
  <ispublished>true</ispublished>
  <categories></categories>
  <comments></comments>
</post>